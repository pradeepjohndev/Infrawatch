import express from "express";
import http from "http";
import { Server } from "socket.io";

const app = express();
const server = http.createServer(app);
const io = new Server(server, {
  cors: { origin: "*" }
});

const pcs = new Map();           // pcId → data
const dashboards = new Set();    // socket ids

app.get("/", (_, res) => {
  res.send("Server running");
});

io.on("connection", (socket) => {
  console.log("Client connected:", socket.id);

  socket.isDashboard = false;

  socket.on("message", (data) => {
    if (!data?.type) return;

    /* ---- DASHBOARD REGISTER ---- */
    if (data.type === "DASHBOARD_REGISTER") {
      socket.isDashboard = true;
      dashboards.add(socket.id);

      console.log("Dashboard connected:", socket.id);

      sendCounts();
      sendDashboardData();
      return;
    }

    /* ---- DEVICE REGISTER ---- */
    if (data.type === "REGISTER") {
      console.log("Device registered:", data.pcId);

      pcs.set(data.pcId, {
        pcId: data.pcId,
        online: true,
        lastSeen: Date.now(),
        staticInfo: data.payload,
        stats: null
      });

      sendCounts();
      sendDashboardData();
      return;
    }

    if (data.type === "SYSTEM_STATS") {
      const pc = pcs.get(data.pcId);
      if (!pc) return;

      pc.stats = data.payload;
      pc.lastSeen = Date.now();
      pc.online = true;

      sendCounts();
      sendDashboardData();
      return;
    }

    if (data.type === "HEARTBEAT") {
      const pc = pcs.get(data.pcId);
      if (pc) {
        pc.lastSeen = Date.now();
        pc.online = true;
      }
    }
  });

  socket.on("disconnect", () => {
    if (socket.isDashboard) {
      dashboards.delete(socket.id);
      console.log("Dashboard disconnected:", socket.id);
    }
  });
});

/* ---- ONLINE / OFFLINE CHECK LOOP ---- */
setInterval(() => {
  const now = Date.now();
  let changed = false;

  pcs.forEach(pc => {
    if (pc.online && now - pc.lastSeen > 6000) {
      pc.online = false;
      changed = true;
    }
  });

  if (changed) {
    sendCounts();
    sendDashboardData();
  }
}, 5000);

/* ---- HELPERS ---- */

function sendCounts() {
  const totalDevices = pcs.size;
  const onlineDevices = [...pcs.values()].filter(p => p.online).length;
  const offlineDevices = totalDevices - onlineDevices;

  const payload = {
    totalDevices,
    onlineDevices,
    offlineDevices
  };

  dashboards.forEach(id => {
    io.to(id).emit("message", {
      type: "COUNTS_UPDATE",
      payload
    });
  });
}

function sendDashboardData() {
  const payload = [...pcs.values()];

  dashboards.forEach(id => {
    io.to(id).emit("message", {
      type: "DASHBOARD_UPDATE",
      payload
    });
  });
}

server.listen(8080, () => {
  console.log("Socket.IO server running on port 8080");
});




Henrix 40C (or 40C Pro) (best bang-for-buck under ₹5k) 
BAJAAO.COM

Kadence Frontier 40" combo (great starter combo if pricing fits your ₹5k) 
Kadence

Vault EA40 Open Box (only if you can stretch a bit) 
Bajaao Open Box



version: "3.9"
services:
  server:
    build: ./Server_side
    ports:
      - "8080:8080"
    restart: always

frontend:
  build: ./Frontend
  ports:
    - "3000:80"
  depends_on:
    - server
  restart: always

docker compose down -v
docker compose up --build --scale agent=5